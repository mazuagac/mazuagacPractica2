---
title: 'Tipología y ciclo de vida de los datos: Práctica 2 Limpieza y validación de los datos'
author: "Autor: Marcos Azuaga Canteras"
date: "Diciembre 2018"
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
    includes:
      in_header: 75.584-PEC-header.html
  pdf_document:
    highlight: zenburn
    toc: yes
  word_document: default
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r , echo=FALSE}

#ruta:https://www.kaggle.com/spscientist/students-performance-in-exams#StudentsPerformance.csv
library(ggplot2)
library(dplyr)
# Lectura de fichero

titanic<- read.csv("D:/UOC/Tipologia y ciclo de vida de los datos/Practica2/train.csv", header = TRUE, stringsAsFactors= FALSE)
# Visualizo la estructura de datos
str(titanic)
```


<p>Los registros del data set:</p>
<ul>
<li>survival: se identifica si el passajero sobrevive o no: 0 = No, 1 = Si</li>
<li>pclass: Identifica la clase del passajero: 1 = 1a, 2 = 2a, 3 = 3a</li>
<li>sex: Identifica el sexo del passajero male= Hombre , female=Mujer	</li> 	
<li>Age: Edad del pasajero.</li> 	
<li>sibsp: Número de Hermanos o Esposo a bordo</li> 	
<li>parch: Número de padres o hijos a bordo</li> 
<li>ticket: Identificador del billete</li> 	
<li>fare: Importe pagado por el pasajero</li> 	
<li>cabin: Número de la cabina</li> 	
<li>embarked 	puerto de embarque C = Cherbourg, Q = Queenstown, S = Southampton </li>
</ul>


```{r , echo=FALSE}
#Renombro la variable sex a los valores F y M
titanic$Sex[titanic$Sex=="female"] <-"F"
titanic$Sex[titanic$Sex=="male"] <-"M"
titanic$Sex<-as.factor(titanic$Sex)

#Renombro la variable survived a los valores V y M
Survived<-titanic$Survived
titanic$Survived[titanic$Survived==0] <-"Muere"
titanic$Survived[titanic$Survived==1] <-"Vive"
titanic$Survived<-as.factor(titanic$Survived)

#Renombro la variable pclass a los valores 1a , 2a y 3a
titanic$Pclass[titanic$Pclass==1] <-"1a"
titanic$Pclass[titanic$Pclass==2] <-"2a"
titanic$Pclass[titanic$Pclass==3] <-"3a"
titanic$Pclass<-as.factor(titanic$Pclass)

#Sumo la variable sibsp y parch para crear una nueva variable llamada familiares a bordo
titanic$Familiares<-titanic$SibSp+titanic$Parch
titanic$SibSp<-NULL
titanic$Parch<-NULL


# Reviso los valores nulos
colSums(is.na(titanic))

#Asigno valores vacios con la media de edad segun sexo
titanic$Age[is.na(titanic$Age) & titanic$Sex=="F"] <- mean(titanic$Age,na.rm=TRUE)
titanic$Age[is.na(titanic$Age) & titanic$Sex=="M"] <- mean(titanic$Age,na.rm=TRUE)

# Reviso los valores vacios
colSums(titanic=="")

#Asigno S a los valores vacios ya que es el más frecuente y no influirán en el resultado
titanic$Embarked[titanic$Embarked==""]="S"
titanic$Embarked<-as.factor(titanic$Embarked)
plot(titanic$Embarked)


#Elimino la columna Cabin ya que hay muchos valores vacios
titanic$Cabin<-NULL

#Elimino las variables Ticket , Name y PassengerId ya que no aportan valor estadistico
titanic$Name<-NULL
titanic$Ticket<-NULL
titanic$PassengerId <-NULL

colSums(titanic=="")
```


```{r , echo=FALSE}
#Buscamos valores extrmos Age
boxplot(titanic$Age)
barplot(table(titanic$Age))
```

Aunque la variable Age se observan valores extremos , son legitimos.

```{r , echo=TRUE}
#Buscamos valores extrmos de la variable Fare
boxplot(titanic$Fare)
barplot(table(titanic$Fare))
max<-sort(unique(titanic$Fare), TRUE)[2]
titanic$Fare[titanic$Fare>max] <-max
m1<-mean(titanic$Fare[titanic$Pclass=="1a"])
m2<-mean(titanic$Fare[titanic$Pclass=="2a"])
m3<-mean(titanic$Fare[titanic$Pclass=="3a"])

titanic$Fare[titanic$Pclass==1 & titanic$Fare==0] <-m1
titanic$Fare[titanic$Pclass==2 & titanic$Fare==0] <-m2
titanic$Fare[titanic$Pclass==3 & titanic$Fare==0] <-m3
```

La variable Fare se observan valores extremos 


```{r , echo=FALSE}

ggplot(data = titanic,aes(x=Embarked,fill=Survived))+geom_bar(position="fill")+facet_wrap(~Pclass)
ggplot(titanic, aes(Sex, fill=Survived)) + geom_bar(position="dodge")

```

#Pruebas estadisiticas

##Prueba de hipotesis

Haremos una prueba estadistica para demostrar si influye el importe pagado por el billete con la posibilidad de sobrevivir o no, con un nivel de confianza del 95%

$$
\left\{
\begin{array}{ll}
H_{0}: \mu_v=\mu_m\\
H_{1}: \mu_v>\mu_m
\end{array}
\right.
$$

```{r echo=TRUE, message=TRUE, warning=FALSE}
TitanicMuere<-titanic[ which(titanic$Survived=="Muere"),]
TitanicVive<-titanic[ which(titanic$Survived=="Vive"),]
nc<-(1-0.95) #nivel de confianza
nM<-length(TitanicMuere$Fare) #número de registros
nV<-length(TitanicVive$Fare) #número de registros nNF
xM<-mean(TitanicMuere$Fare)#Media Fumador
xV<-mean(TitanicVive$Fare)#Media No Fumador xNF
resultadoM <- (TitanicMuere$Fare - xM)^2
vM<-sum(resultadoM)/(nM-1) #Varianza Fumador
resultadoV <- (TitanicVive$Fare - xV)^2
vV<-sum(resultadoV)/(nV-1)#Varianza No Fumador
z<-(xV-xM)/sqrt((vM/nM)+(vV/nV)) #Estadístico de contraste

sprintf("El valor estadístico de contraste es: %.4f",z)
vc<-qnorm(nc,mean=0,sd=1) #Valor crítico
sprintf("El valor crítico es: %.4f",vc)
p<-pnorm(z,mean=0,sd=1,lower.tail = F)#p-Valor
sprintf("El p-valor es: %.4f",p)
```
```{r , echo=FALSE}
TitanicMuere<-titanic[ which(titanic$Survived=="Muere"),]
TitanicVive<-titanic[ which(titanic$Survived=="Vive"),]

boxplot(TitanicMuere$Fare,TitanicVive$Fare,main="Diagrama de caja.",names=c("Muere","Vive"))
hist(TitanicMuere$Fare, freq = FALSE)
curve(dnorm(x, mean(TitanicMuere$Fare), sd(TitanicMuere$Fare)), col = 2, lty = 2, lwd = 2, add=T)

hist(TitanicVive$Fare, freq = FALSE)
curve(dnorm(x, mean(TitanicVive$Fare), sd(TitanicVive$Fare)), col = 2, lty = 2, lwd = 2, add=T)

t.test(TitanicVive$Fare,TitanicMuere$Fare,alternative="great",conf.level=0.95, var.equal=FALSE)


```

Como el p-valor es 0.00 inferior a 0.05 , entonces rechazmos la hipotesis nula y aceptamos la hipotesis alternativa con lo que los supervivientes pagarón mas de media que los que murieron.




##Regresión lineal


```{r , echo=FALSE}

RegModelo <- lm(Survived ~ titanic$Sex+ titanic$Pclass+ titanic$Age + titanic$Fare + titanic$Embarked+ titanic$Familiares )
RegModelo
```
```{r , echo=FALSE}

test.titanic<-data.frame(titanic$Pclass,titanic$Sex,titanic$Age,titanic$Fare,titanic$Embarked,titanic$Familiares)
colnames(test.titanic)<-c("Pclass","Sex","Age","Fare","Embarked","Familiares")
test.titanic$PredictPre<-predict(RegModelo, newdata =test.titanic, interval = "prediction")
test.titanic$Predict<-(1/(1+exp(-(test.titanic$PredictPre))))

library(SDMTools)
c<-confusion.matrix(Survived,test.titanic$Predict[,1],0.6)
todo<-c[1,1]+c[1,2]+c[2,1]+c[2,2]
correcto<-c[1,1]+c[2,2]
porC<-((correcto)*100)/todo
porC
porF<-100-porC
porF
```

